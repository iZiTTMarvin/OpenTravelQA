# -*- coding: utf-8 -*-
"""
===============================================================================
基于规则的旅游景点问答系统 (Rule-based QA)
===============================================================================
作者: 王思琪团队
描述: 本模块实现了基于规则的问答方法，通过关键词匹配识别用户意图，
      通过词典匹配识别景点实体，最后根据槽位填充逻辑生成回答。

核心组件:
    1. 意图识别规则 - 基于关键词匹配用户询问的意图
    2. 实体识别规则 - 基于词典匹配景点名称和城市名称
    3. 槽位填充逻辑 - 根据意图确定需要返回的字段
    4. 回答模板设计 - 不同意图对应不同的回答模板
===============================================================================
"""

import pandas as pd
import re
import os
from typing import Dict, List, Tuple, Optional

# ============================================================================
# 第一部分：意图识别规则定义
# ============================================================================
# 定义不同意图对应的关键词列表
# 系统会根据用户问题中出现的关键词来判断用户的真实意图

意图关键词映射表 = {
    # 询问门票价格的意图
    "ASK_TICKET": [
        "门票", "票价", "多少钱", "收费", "免费", "价格", 
        "费用", "票", "入场费", "入园费", "需要花多少"
    ],
    
    # 询问开放时间的意图
    "ASK_OPEN_TIME": [
        "开放时间", "营业时间", "几点开门", "几点关门", "开门时间",
        "关门时间", "什么时候开", "什么时候关", "开到几点", "几点开始",
        "几点结束", "开放", "营业", "运营时间"
    ],
    
    # 询问景点简介/描述的意图
    "ASK_INTRO": [
        "介绍", "简介", "是什么", "什么样", "怎么样", "好玩吗",
        "有什么", "特色", "亮点", "描述", "概况", "情况",
        "讲讲", "说说", "告诉我", "了解"
    ],
    
    # 询问地址/位置的意图
    "ASK_ADDRESS": [
        "地址", "在哪", "在哪里", "位置", "怎么去", "哪里",
        "坐落", "位于", "地点", "所在地"
    ],
    
    # 询问联系电话的意图
    "ASK_PHONE": [
        "电话", "联系方式", "联系电话", "手机", "号码", 
        "打电话", "咨询电话", "客服电话", "热线"
    ],
    
    # 询问官方网站的意图
    "ASK_WEBSITE": [
        "官网", "网站", "网址", "官方网站", "主页", "网页"
    ],
    
    # 询问评分/评价的意图
    "ASK_RATING": [
        "评分", "评价", "口碑", "好不好", "怎么样", "评级",
        "星级", "分数", "打分", "推荐指数"
    ],
    
    # 询问游玩建议时间的意图
    "ASK_SUGGEST_TIME": [
        "玩多久", "游玩时间", "需要多长时间", "多久能玩完",
        "建议时间", "推荐时间", "游览时间", "参观时间",
        "待多久", "花多长时间"
    ],
    
    # 询问标签/类型的意图
    "ASK_TAGS": [
        "标签", "类型", "分类", "属于什么", "什么类型",
        "主题", "风格", "特点"
    ],
    
    # 询问游玩贴士/注意事项的意图
    "ASK_TIPS": [
        "贴士", "小贴士", "注意事项", "注意", "提醒", "建议",
        "攻略", "技巧", "经验", "须知", "提示", "要注意什么"
    ],
    
    # 询问所在城市/省份的意图
    "ASK_LOCATION": [
        "哪个城市", "什么城市", "哪个省", "什么省", 
        "属于哪里", "归属", "所在城市", "所在省份"
    ],
    
    # 综合推荐意图
    "ASK_RECOMMEND": [
        "推荐", "有什么好玩的", "值得去吗", "好玩的地方",
        "旅游景点", "去哪玩", "哪里好玩"
    ]
}


# ============================================================================
# 第二部分：实体识别词典定义
# ============================================================================
# 实体识别需要从知识库中动态构建词典

def 构建实体词典(知识库: pd.DataFrame) -> Dict[str, List[str]]:
    """
    从知识库中构建实体识别词典
    
    参数:
        知识库: 包含景点数据的DataFrame
        
    返回:
        包含景点名称列表和城市名称列表的字典
    """
    实体词典 = {
        # 景点名称列表（去重）
        "景点名称": 知识库["name"].dropna().unique().tolist(),
        # 城市名称列表（去重）
        "城市名称": 知识库["city"].dropna().unique().tolist(),
        # 省份名称列表（去重）
        "省份名称": 知识库["province"].dropna().unique().tolist()
    }
    return 实体词典


# ============================================================================
# 第三部分：意图识别函数
# ============================================================================

def 识别意图(用户问题: str) -> Tuple[str, float]:
    """
    基于关键词匹配识别用户问题的意图
    
    参数:
        用户问题: 用户输入的自然语言问题
        
    返回:
        (意图标签, 置信度分数) 的元组
        
    工作原理:
        1. 遍历所有意图关键词映射表
        2. 统计用户问题中出现的关键词数量
        3. 选择匹配关键词最多的意图作为结果
        4. 置信度 = 匹配的关键词数量 / 该意图的总关键词数量
    """
    最高匹配数 = 0
    识别到的意图 = "UNKNOWN"  # 默认意图为未知
    置信度 = 0.0
    
    for 意图, 关键词列表 in 意图关键词映射表.items():
        # 统计当前意图的关键词在用户问题中出现的次数
        匹配数 = sum(1 for 关键词 in 关键词列表 if 关键词 in 用户问题)
        
        if 匹配数 > 最高匹配数:
            最高匹配数 = 匹配数
            识别到的意图 = 意图
            # 计算置信度：匹配数 / 关键词总数
            置信度 = 匹配数 / len(关键词列表)
    
    # 如果置信度过低，返回未知意图
    if 置信度 < 0.05:
        return "UNKNOWN", 0.0
        
    return 识别到的意图, min(置信度, 1.0)


# ============================================================================
# 第四部分：实体识别函数
# ============================================================================

def 识别实体(用户问题: str, 实体词典: Dict[str, List[str]]) -> Dict[str, List[str]]:
    """
    基于词典匹配识别用户问题中的实体
    
    参数:
        用户问题: 用户输入的自然语言问题
        实体词典: 包含景点名称、城市名称等实体的词典
        
    返回:
        识别到的实体字典，格式为 {"景点": [...], "城市": [...], "省份": [...]}
        
    工作原理:
        1. 遍历词典中的所有实体
        2. 检查每个实体是否出现在用户问题中
        3. 返回所有匹配的实体
    """
    识别结果 = {
        "景点": [],
        "城市": [],
        "省份": []
    }
    
    # 识别景点名称
    for 景点名 in 实体词典.get("景点名称", []):
        if 景点名 in 用户问题:
            识别结果["景点"].append(景点名)
    
    # 识别城市名称
    for 城市名 in 实体词典.get("城市名称", []):
        if 城市名 in 用户问题:
            识别结果["城市"].append(城市名)
    
    # 识别省份名称
    for 省份名 in 实体词典.get("省份名称", []):
        if 省份名 in 用户问题:
            识别结果["省份"].append(省份名)
    
    return 识别结果


# ============================================================================
# 第五部分：槽位填充逻辑
# ============================================================================
# 定义每种意图需要返回的数据字段

意图槽位映射表 = {
    "ASK_TICKET": ["name", "ticket_price"],           # 询问门票 -> 返回景点名和票价
    "ASK_OPEN_TIME": ["name", "open_time"],           # 询问开放时间 -> 返回景点名和开放时间
    "ASK_INTRO": ["name", "description"],             # 询问简介 -> 返回景点名和描述
    "ASK_ADDRESS": ["name", "address", "city", "province"],  # 询问地址 -> 返回详细地址信息
    "ASK_PHONE": ["name", "phone"],                   # 询问电话 -> 返回景点名和电话
    "ASK_WEBSITE": ["name", "website"],               # 询问网站 -> 返回景点名和官网
    "ASK_RATING": ["name", "rating"],                 # 询问评分 -> 返回景点名和评分
    "ASK_SUGGEST_TIME": ["name", "suggest_time"],     # 询问游玩时间 -> 返回景点名和建议时间
    "ASK_TAGS": ["name", "tags"],                     # 询问标签 -> 返回景点名和标签
    "ASK_TIPS": ["name", "tips"],                     # 询问贴士 -> 返回景点名和贴士
    "ASK_LOCATION": ["name", "city", "province"],     # 询问位置 -> 返回城市和省份
    "ASK_RECOMMEND": ["name", "rating", "description", "tags"],  # 推荐 -> 返回综合信息
    "UNKNOWN": ["name", "description"]                # 未知意图 -> 默认返回简介
}


def 填充槽位(意图: str, 景点数据: pd.Series) -> Dict[str, str]:
    """
    根据意图从景点数据中提取对应的槽位值
    
    参数:
        意图: 识别到的用户意图
        景点数据: 匹配到的景点的一行数据（pandas Series）
        
    返回:
        包含槽位名称和对应值的字典
    """
    需要的字段 = 意图槽位映射表.get(意图, ["name", "description"])
    槽位值 = {}
    
    for 字段 in 需要的字段:
        if 字段 in 景点数据.index:
            值 = 景点数据[字段]
            # 处理空值情况
            if pd.isna(值) or 值 == "":
                槽位值[字段] = "暂无信息"
            else:
                槽位值[字段] = str(值)
        else:
            槽位值[字段] = "暂无信息"
    
    return 槽位值


# ============================================================================
# 第六部分：回答模板设计
# ============================================================================
# 定义每种意图对应的回答模板

回答模板库 = {
    "ASK_TICKET": "【{name}】的门票价格为：{ticket_price}",
    
    "ASK_OPEN_TIME": "【{name}】的开放时间为：{open_time}",
    
    "ASK_INTRO": "【{name}】景点简介：\n{description}",
    
    "ASK_ADDRESS": "【{name}】的地址信息：\n省份：{province}\n城市：{city}\n详细地址：{address}",
    
    "ASK_PHONE": "【{name}】的联系电话为：{phone}",
    
    "ASK_WEBSITE": "【{name}】的官方网站为：{website}",
    
    "ASK_RATING": "【{name}】的用户评分为：{rating} 分（满分5分）",
    
    "ASK_SUGGEST_TIME": "【{name}】的建议游玩时间为：{suggest_time}",
    
    "ASK_TAGS": "【{name}】的景点标签：{tags}",
    
    "ASK_TIPS": "【{name}】的游玩贴士：\n{tips}",
    
    "ASK_LOCATION": "【{name}】位于{province}{city}",
    
    "ASK_RECOMMEND": "为您推荐【{name}】（评分：{rating}）\n标签：{tags}\n简介：{description}",
    
    "UNKNOWN": "关于【{name}】，这里是它的基本介绍：\n{description}"
}

# 无法找到景点时的默认回复模板
无景点回复模板 = "抱歉，我没有找到您询问的景点信息。请确认景点名称是否正确，或者尝试换一种问法。"

# 推荐城市景点的模板
城市推荐模板 = "为您推荐{city}的热门景点：\n{景点列表}"


def 生成回答(意图: str, 槽位值: Dict[str, str]) -> str:
    """
    根据意图和槽位值生成最终回答
    
    参数:
        意图: 识别到的用户意图
        槽位值: 填充好的槽位值字典
        
    返回:
        生成的自然语言回答
    """
    模板 = 回答模板库.get(意图, 回答模板库["UNKNOWN"])
    
    try:
        回答 = 模板.format(**槽位值)
    except KeyError as e:
        # 如果模板中有未提供的字段，使用默认模板
        回答 = f"关于【{槽位值.get('name', '该景点')}】：暂时无法获取您询问的具体信息。"
    
    return 回答


# ============================================================================
# 第七部分：知识库查询函数
# ============================================================================

def 查询景点(景点名称: str, 知识库: pd.DataFrame) -> Optional[pd.Series]:
    """
    从知识库中查询指定景点的信息
    
    参数:
        景点名称: 要查询的景点名称
        知识库: 景点数据DataFrame
        
    返回:
        如果找到则返回景点数据（Series），否则返回None
    """
    # 精确匹配
    匹配结果 = 知识库[知识库["name"] == 景点名称]
    if not 匹配结果.empty:
        return 匹配结果.iloc[0]
    
    # 模糊匹配：检查景点名是否包含在用户输入中，或用户输入是否包含在景点名中
    for _, 行 in 知识库.iterrows():
        if 景点名称 in 行["name"] or 行["name"] in 景点名称:
            return 行
    
    return None


def 查询城市景点(城市名称: str, 知识库: pd.DataFrame, 数量限制: int = 3) -> List[pd.Series]:
    """
    从知识库中查询指定城市的景点列表
    
    参数:
        城市名称: 要查询的城市名称
        知识库: 景点数据DataFrame
        数量限制: 返回的最大景点数量
        
    返回:
        景点数据列表
    """
    城市景点 = 知识库[知识库["city"] == 城市名称]
    
    # 按评分排序，返回评分最高的景点
    if not 城市景点.empty:
        城市景点 = 城市景点.sort_values(by="rating", ascending=False)
        return [城市景点.iloc[i] for i in range(min(数量限制, len(城市景点)))]
    
    return []


# ============================================================================
# 第八部分：主问答函数
# ============================================================================

def rule_based_qa(question: str, kb: pd.DataFrame) -> Dict:
    """
    基于规则的问答主函数
    
    参数:
        question: 用户输入的问题（字符串）
        kb: 知识库DataFrame，包含景点数据
        
    返回:
        包含以下字段的字典:
        - intent: 识别到的意图
        - intent_confidence: 意图识别的置信度
        - entities: 识别到的实体
        - answer: 生成的回答
        - matched_attraction: 匹配到的景点名称（如果有）
        - slots: 填充的槽位值
        
    使用示例:
        >>> import pandas as pd
        >>> kb = pd.read_csv("data/merged_attractions.csv")
        >>> result = rule_based_qa("上海迪士尼的门票多少钱？", kb)
        >>> print(result["answer"])
    """
    # 初始化返回结果
    结果 = {
        "intent": "UNKNOWN",
        "intent_confidence": 0.0,
        "entities": {"景点": [], "城市": [], "省份": []},
        "answer": "",
        "matched_attraction": None,
        "slots": {}
    }
    
    # 第一步：构建实体词典
    实体词典 = 构建实体词典(kb)
    
    # 第二步：识别意图
    意图, 置信度 = 识别意图(question)
    结果["intent"] = 意图
    结果["intent_confidence"] = 置信度
    
    # 第三步：识别实体
    实体 = 识别实体(question, 实体词典)
    结果["entities"] = 实体
    
    # 第四步：根据实体查询知识库并生成回答
    if 实体["景点"]:
        # 如果识别到景点名称，查询该景点的信息
        景点名 = 实体["景点"][0]  # 取第一个识别到的景点
        景点数据 = 查询景点(景点名, kb)
        
        if 景点数据 is not None:
            结果["matched_attraction"] = 景点数据["name"]
            # 填充槽位
            槽位值 = 填充槽位(意图, 景点数据)
            结果["slots"] = 槽位值
            # 生成回答
            结果["answer"] = 生成回答(意图, 槽位值)
        else:
            结果["answer"] = 无景点回复模板
            
    elif 实体["城市"]:
        # 如果只识别到城市名称，推荐该城市的热门景点
        城市名 = 实体["城市"][0]
        城市景点列表 = 查询城市景点(城市名, kb)
        
        if 城市景点列表:
            景点信息列表 = []
            for i, 景点 in enumerate(城市景点列表, 1):
                景点信息 = f"{i}. 【{景点['name']}】- 评分：{景点['rating']}"
                景点信息列表.append(景点信息)
            
            结果["answer"] = 城市推荐模板.format(
                city=城市名,
                景点列表="\n".join(景点信息列表)
            )
            结果["matched_attraction"] = "城市推荐"
        else:
            结果["answer"] = f"抱歉，暂时没有找到{城市名}的景点信息。"
    else:
        # 没有识别到任何实体
        # 尝试从问题中模糊匹配景点名
        找到景点 = False
        for 景点名 in 实体词典["景点名称"]:
            if 景点名 in question:
                景点数据 = 查询景点(景点名, kb)
                if 景点数据 is not None:
                    结果["matched_attraction"] = 景点数据["name"]
                    槽位值 = 填充槽位(意图, 景点数据)
                    结果["slots"] = 槽位值
                    结果["answer"] = 生成回答(意图, 槽位值)
                    找到景点 = True
                    break
        
        if not 找到景点:
            结果["answer"] = "抱歉，请在问题中提供具体的景点名称或城市名称，以便我为您查询相关信息。\n\n您可以这样问：\n- 上海迪士尼的门票多少钱？\n- 外滩的开放时间是什么时候？\n- 给我介绍一下豫园\n- 上海有什么好玩的景点？"
    
    return 结果


# ============================================================================
# 第九部分：测试代码
# ============================================================================

if __name__ == "__main__":
    # 获取当前脚本所在目录
    当前目录 = os.path.dirname(os.path.abspath(__file__))
    # 构建数据文件路径（数据文件在上级目录的data文件夹中）
    数据文件路径 = os.path.join(当前目录, "..", "data", "merged_attractions.csv")
    
    # 加载知识库
    print("=" * 60)
    print("基于规则的旅游景点问答系统 - 测试")
    print("=" * 60)
    
    try:
        知识库 = pd.read_csv(数据文件路径)
        print(f"成功加载知识库，共 {len(知识库)} 条景点数据")
    except Exception as e:
        print(f"加载知识库失败: {e}")
        exit(1)
    
    # 测试问题列表
    测试问题 = [
        "上海迪士尼的门票多少钱？",
        "外滩的开放时间是什么时候？",
        "给我介绍一下豫园",
        "东方明珠在哪里？",
        "上海有什么好玩的景点？",
        "朱家角古镇的游玩建议时间是多久？",
        "上海博物馆的电话是多少？"
    ]
    
    print("\n" + "-" * 60)
    print("开始测试...")
    print("-" * 60)
    
    for 问题 in 测试问题:
        print(f"\n【用户问题】{问题}")
        结果 = rule_based_qa(问题, 知识库)
        print(f"【识别意图】{结果['intent']} (置信度: {结果['intent_confidence']:.2f})")
        print(f"【识别实体】{结果['entities']}")
        print(f"【匹配景点】{结果['matched_attraction']}")
        print(f"【系统回答】\n{结果['answer']}")
        print("-" * 40)
